---

name: GMT Tests native
author: Arne Tarara <arne@green-coding.io>
description: Run GMT Tests inside systemd and DinD compatible sysbox-runc container

services:
  ubuntu-systemd-docker:
    type: container
    image: greencoding/ubuntu-systemd-docker

flow:
  - name: Pull GMT
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: git clone https://github.com/green-coding-solutions/green-metrics-tool --depth 1 --single-branch --recurse-submodules --shallow-submodules
        log-stdout: true

  - name: Setup SSH keys
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool
          sed -i "s#git@github.com:green-coding-solutions/gmt-enterprise.git#git@github-custom:green-coding-solutions/gmt-enterprise.git#" .gitmodules
          git submodule sync
          mkdir -p ~/.ssh
          echo '__GMT_VAR_SSH_PRIVATE_KEY__' > ~/.ssh/id_github
          chmod 0600 ~/.ssh/id_github
          echo -e '\nHost github-custom\n    HostName github.com\n    User git\n    IdentityFile ~/.ssh/id_github' >> ~/.ssh/config
        shell: bash
        log-stdout: true


  - name: Install GMT base
    container: ubuntu-systemd-docker
    commands:
      - type: console
        # we set here --nvidia-gpu altough the M4 machine does not have any. We want to test if the headers can be correctly downloaded
        command: |
          cd ~/green-metrics-tool
          ./install_linux.sh -p testpw -a http://api.green-coding.internal:9142 -m http://metrics.green-coding.internal:9142 -T -L -z -f -j -d -g -e bare-metal-M4-tests --no-ai --nvidia-gpu
        shell: bash
        log-stdout: true


  - name: Install GMT dev requirements
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool
          source venv/bin/activate
          python3 -m pip install -r requirements-dev.txt
          playwright install --with-deps firefox
        shell: bash
        log-stdout: true


  - name: Setup Test Env
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          source venv/bin/activate
          cd ~/green-metrics-tool/tests
          python3 setup-test-env.py --ee
        shell: bash
        log-stdout: true


  - name: Start Test Containers
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool/tests
          source ../venv/bin/activate
          ./start-test-containers.sh -d
        shell: bash
        log-stdout: true


  - name: Run Tests
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool/tests
          python3 -m pytest -vv -rA
        shell: bash
        log-stdout: true


  - name: Stop Test Containers
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool/tests
          ./stop-test-containers.sh
        shell: bash
        log-stdout: true




