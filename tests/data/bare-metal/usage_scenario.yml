---

name: GMT Tests native
author: Arne Tarara <arne@green-coding.io>
description: Run GMT Tests inside systemd and DinD compatible sysbox-runc container

services:
  ubuntu-systemd-docker:
    type: container
    build:
      context: .
      dockerfile: Dockerfile

flow:
  - name: Pull GMT
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: git clone https://github.com/green-coding-solutions/green-metrics-tool
  - name: Install GMT base
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: cd ~/green-metrics-tool && ./install_linux.sh -p testpw -a http://api.green-coding.internal:9142 -m http://metrics.green-coding.internal:9142 -B -T -L -z -f -j -d -g -e github-actions-test --nvidia-gpu --ai
        shell: bash

  - name: Install GMT dev requirements
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: cd ~/green-metrics-tool && source venv/bin/activate && python3 -m pip install -r requirements-dev.txt && playwright install --with-deps firefox && cd tests && python3 setup-test-env.py --no-docker-build --ee
        shell: bash

  - name: Start Test Containers
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: cd ~/green-metrics-tool/tests && source ../venv/bin/activate && ./start-test-containers.sh -d
        shell: bash

  - name: Run Tests
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: cd ~/green-metrics-tool/tests && python3 -m pytest -vv -rA
        shell: bash

  - name: Stop Test Containers
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: cd ~/green-metrics-tool/tests && ./stop-test-containers.sh
        shell: bash



