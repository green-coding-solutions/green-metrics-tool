---

name: GMT Tests native
author: Arne Tarara <arne@green-coding.io>
description: Run GMT Tests inside systemd and DinD compatible sysbox-runc container

services:
  ubuntu-systemd-docker:
    type: container
    image: greencoding/ubuntu-systemd-docker
    networks:
      - bridge
    volumes:
      - gmt-tests-pip-cache:/root/.cache/pip/
      - gmt-tests-apt-package-cache:/var/cache/apt/
      - gmt-tests-apt-list-cache:/var/lib/apt/lists/
      - gmt-tests-buildkit-cache:/root/.cache/buildkit-gmt/
    setup-commands:
      - command: rm /etc/apt/apt.conf.d/docker-clean # the image comes with a script that deletes all apt packages after install. we do not want that

flow:
  - name: Pull GMT
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: git clone https://github.com/green-coding-solutions/green-metrics-tool --depth 1 --single-branch --recurse-submodules --shallow-submodules

  - name: Install GMT base
    container: ubuntu-systemd-docker
    commands:
      - type: console
        # we set here --nvidia-gpu although the M4 machine does not have any. We want to test if the headers can be correctly downloaded
        command: |
          cd ~/green-metrics-tool
          ./install_linux.sh -p testpw -a http://api.green-coding.internal:9142 -m http://metrics.green-coding.internal:9142 -T -L -z -f -j -d -g --nvidia-gpu
        shell: bash

  - name: Install GMT dev requirements
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool
          source venv/bin/activate
          python3 -m pip install -r requirements-dev.txt
          playwright install --with-deps firefox
        shell: bash


  - name: Setup Test Env
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool/tests
          source ../venv/bin/activate
          python3 setup-test-env.py
        shell: bash


  - name: Start Test Containers
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool/tests
          source ../venv/bin/activate
          ./start-test-containers.sh -d
        shell: bash

  - name: Run Tests
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool/tests
          source ../venv/bin/activate
          python3 -m pytest --durations=0 -vv -rA
        shell: bash

  - name: Stop Test Containers
    container: ubuntu-systemd-docker
    commands:
      - type: console
        command: |
          cd ~/green-metrics-tool/tests
          ./stop-test-containers.sh
        shell: bash




