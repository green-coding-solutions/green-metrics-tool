---
name: "Website Test (__GMT_VAR_PAGE__)"
author: Arne Tarara <arne@green-coding.io>
description: "Opens __GMT_VAR_PAGE__, waits for full load"

sci:
  R_d: Website load

compose-file: !include compose.yml

flow:
  - name: Starting browser IPC
    container: playwright-nodejs
    commands:
      - type: console
        command: node /tmp/energy-tests/templates/website/playwright-ipc.js --headless true --browser firefox
        note: Starting browser in background process with IPC
        detach: true
      - type: console
        command: until [ -p "/tmp/playwright-ipc-ready" ]; do sleep 1; done && echo "Browser ready!"
        shell: bash
        note: Waiting for website stepper loop to start by monitoring rendevous file endpoint

  - name: Warmup and Caching
    container: playwright-nodejs
    commands:
      - type: playwright
        command: await page.goto("__GMT_VAR_PAGE__");
      - type: console
        command: sleep '__GMT_VAR_SLEEP__'
      - type: playwright
        command: await context.close()
      - type: playwright
        command: context = await browser.newContext(contextOptions);
      - type: playwright
        command: page = await context.newPage()

  - name: Dump Log (Warmup)
    container: squid
    commands:
      - type: console
        command: cat /apps/squid/var/logs/access.log
      - type: console
        command: grep 'TCP_MISS/' /apps/squid/var/logs/access.log #validate that TCP_MISSes present
      - type: console
        command: echo > /apps/squid/var/logs/access.log
        shell: bash

  - name: Load and idle
    container: playwright-nodejs
    commands:
      - type: playwright
        command: await page.goto("__GMT_VAR_PAGE__");
      - type: console
        command: sleep '__GMT_VAR_SLEEP__'

  - name: Dump Log (Load and idle)
    container: squid
    commands:
      - type: console
        command: cat /apps/squid/var/logs/access.log
        read-notes-stdout: true
      - type: console
        command: grep 'TCP_MEM_HIT/' /apps/squid/var/logs/access.log #validate that TCP_MEM_HITs present
        # This is sadly too strict. Pages fingerprint you all the time and a new request might get a new fingerprint that will not be cached
        # But if you have a page that does not fingerprint we recommend having this uncommented, as it will warn you if resources bypass the cache pre-loading
#      - type: console
#        command: awk '/TCP_MISS\// { found=1 } END { exit found }' /apps/squid/var/logs/access.log # ensure no TCP_MISSes present
