---
name: "Website Test (__GMT_VAR_PAGE__)"
author: Arne Tarara <arne@green-coding.io>
description: "Opens __GMT_VAR_PAGE__ from a cache and waits for full load + 5 seconds"

sci:
  R_d: Website load

compose-file: !include-gmt-helper gmt-playwright-with-cache.yml

flow:
  - name: Warmup and Caching
    container: gmt-playwright-nodejs
    hidden: true
    commands:
      - type: playwright
        command: await gmtPlaywrightCache("__GMT_VAR_PAGE__", __GMT_VAR_SLEEP__);

  - name: Visit page and idle for __GMT_VAR_SLEEP__ s
    container: gmt-playwright-nodejs
    commands:
      - type: playwright
        command: page_result = await page.goto("__GMT_VAR_PAGE__");
      - type: console
        command: sleep __GMT_VAR_SLEEP__

  - name: Check HTTP Status Code
    container: gmt-playwright-nodejs
    hidden: true
    commands:
      - type: playwright
        command: if (!page_result.ok()) throw `Page was not accessible. HTTP Return code ${page_result.status()}`

  - name: Scroll down and wait for __GMT_VAR_SLEEP__ s
    container: gmt-playwright-nodejs
    commands:
      - type: playwright
        command: |
          let loop_ticks = 0;
          const max_loop_ticks = 200;

          while (loop_ticks < max_loop_ticks) {
            const atBottom = await page.evaluate(() => {
              const d = document.documentElement;
              return d.scrollTop + window.innerHeight >= d.scrollHeight;
            });
            if (atBottom) break;

            await page.mouse.wheel(0, 200);
            await page.waitForTimeout(200);

            loop_ticks++;
          }
      - type: console
        command: sleep __GMT_VAR_SLEEP__
